#!/bin/sh

set -e

test -z "$3" || echo usage: asklogin [icon-id] text
test -z "$3"

iconid=128
text="$1"
test -z "$2" || iconid="$1"
test -z "$2" || text="$2"

test -n "$text" || text="Enter username and password:"

cd /gui/new/port

echo 5 > procid

echo Login   > title
echo 300,150 > size

ln /gui/new/stack view

focuser=view/.focuser/v
icon=view/icon/v
main=view/main/v
user=view/user/v
pass=view/pass/v
ok=view/ok/v
cancel=view/cancel/v
defaultkeys=view/defaultkeys/v

ln /gui/new/focuser $focuser

ln /gui/new/frame $icon

echo 32 > $icon/width
echo 32 > $icon/height
echo 13 > $icon/.margin-top
echo 23 > $icon/.margin-left
echo 23 > $icon/.margin-right

ln /gui/new/icon $icon/v

ln /gui/new/frame $main

echo 13 > $main/.margin-top
echo 13 > $main/.margin-right
echo 103 > $main/.margin-bottom
echo 78 > $main/.margin-left

ln /gui/new/caption $main/v

ln /gui/new/frame $user

echo 16 > $user/height
echo 13 > $user/.margin-right
echo 81 > $user/.margin-bottom
echo 78 > $user/.margin-left
echo 1 > $user/.outline-width
echo 2 > $user/padding

ln /gui/new/textedit $user/v

ln /gui/new/frame $pass

echo 16 > $pass/height
echo 13 > $pass/.margin-right
echo 49 > $pass/.margin-bottom
echo 78 > $pass/.margin-left
echo 1 > $pass/.outline-width
echo 2 > $pass/padding

ln /gui/new/textedit $pass/v

ln /gui/new/frame $ok

echo 58 > $ok/width
echo 20 > $ok/height
echo 13 > $ok/.margin-right
echo 13 > $ok/.margin-bottom

echo 3 > $ok/.outline-width
echo 1 > $ok/.outline-offset
echo 16 > $ok/.outline-curvature

ln /gui/new/button $ok/v

ln /gui/new/frame $cancel

echo 58 > $cancel/width
echo 20 > $cancel/height
echo 84 > $cancel/.margin-right
echo 13 > $cancel/.margin-bottom

ln /gui/new/button $cancel/v

echo $iconid > $icon/v/data
echo 1 > $icon/v/disabling

echo $text > $main/v/text
echo 1     > $main/v/disabling

echo 1 > $user/v/singular
echo 1 > $pass/v/singular
echo 1 > $pass/v/secret

echo Cancel > $cancel/v/title

ln -s $ok/v/click accept
ln -s $cancel/v/click cancel

ln /gui/new/defaultkeys $defaultkeys

#echo 1 > $ok/v/disabled

touch window

echo 0 > w/text-font
#echo ddd > w/back-color

perl -e 'LOOP: $_ = `select -1 -r{'$ok,$cancel'}/v/socket` or exit 2; /cancel/ && exit 1; readlink( "focus" ) =~ m{/'$user'/v$} and unlink "focus" and symlink "'$pass'/v", "focus" and goto LOOP'

cat $user/v/text && echo && cat $pass/v/text && echo

